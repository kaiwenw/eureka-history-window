<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <link href={{ url_for('static', filename='styles.css') }} rel="stylesheet">
    <title>Eureka History Window</title>
  </head>
  <body>

    <div style="float:left; width:25%">
      <h1>Currently showing {{ session_name }}.</h1> 
      <form> 
        Select a folder to analyze:
        <select value={{session_name}}, id='select_log' onchange='refreshPage()'>
        {% for log_name in candidate_logs %}
          {% if log_name == session_name %}
          <option selected>{{ log_name }}</option>
          {% else %}
          <option>{{ log_name }}</option>
          {% endif %}
        {% endfor %}
        </select>
      </form>
    </div>
    <br>
    <br>
    <br>
    <br>
    <br>


  {% if rows is defined and rows | length > 0 %}
    <table border=1 frame=void rules=rows>
    <!-- headers -->
    <tr>
      <td>Session</td>
      <!-- <td>Timestamp</td> -->
      <td>Predicates</td>

      <!-- statistics -->
      {% for stat_key in rows[0]['per_img'][0]['derived_stats'].keys() %}
        <td>{{ stat_key }}</td>
      {% endfor %}
    </tr>

    <!-- data per row -->
    {% for i in range(rows | length) %}
    <tr>
        <td>
          <br>
          Session Num: {{ i }}<br>
          Type: {{ rows[i]['info']['type'] }}<br>
          <br>
          <a href="/replay/{{i}}" target="blank">
            <button class='btn btn-default'>Replay</button>
          </a>
        </td>
        <!-- <td>
          {{ rows[i]['derived_info']['start_time'] }}<br>
                Until...<br>
          {{ rows[i]['derived_info']['end_time'] }}
        </td> -->
        <td>
            {% for pred in rows[i]['predicates'] %}
            - {{ pred.instanceName }}<br>
              Pos: {{ pred.numPositives }}, Neg: {{ pred.numNegatives }}<br>
            {% endfor %}
            <br>
            <a href="/download/{{i}}" target="blank">
              <button class='btn btn-default'>Download Predicates!</button>
            </a>
        </td>

        <!-- statistics data for last one (overall) -->
        {% for stat_key, stat_val in rows[i]['per_img'][-1]['derived_stats'].items() %}
        <!-- hacky check for whether it's a float -->
        {% if (stat_val | int) != stat_val %}
          <td>{{ "%.3f" | format(stat_val) }}</td>
        {% else %}
          <td>{{ stat_val }}</td>
        {% endif %}
        {% endfor %}
    </tr>
    {% endfor %}
    </table>

    <br>
    <br>
    <div style="float:left; width:25%">
      <form> 
        <!-- Each parameter is a field of derived stats -->
        Select a parameter to plot time-series: 
        <select id='select_plot' onchange='plotDataSelector()'>
        {% for stat_key, stat_val in rows[0]['per_img'][0]['derived_stats'].items() %}
          {% if 'elapsed_time' not in stat_key %}
          <option>{{ stat_key }}</option>
          {% endif %}
        {% endfor %}
        </select>
      </form>
    </div>
    <div style="float:left; width:25%" id="history_plots">
    </div>

  {% endif %}

  </body>
<script src={{ url_for('static', filename='plot.js') }}></script>  
<script>


function refreshPage() {
  var mylist = document.getElementById('select_log')
  var selection = mylist.options[mylist.selectedIndex].text;
  var req = new XMLHttpRequest();
  req.open('GET', '/update_log_folder/' + selection, true);
  req.send();
  window.location.assign("/")
}

data = null;

// method called when selection changes, to plot the selected curve
function plotDataSelector() {
  if (data == null) {
    console.log("no data!");
    return;
  }
  svg.selectAll('*').remove();
  var mylist = document.getElementById('select_plot')
  var selection = mylist.options[mylist.selectedIndex].text;
  plot_data(data, function(d) {return d['metadata']['arrival_time']; }, 'Time',
                  function(d) {return d['derived_stats'][selection]; }, selection)
}

function refreshPlot() {
  var req = new XMLHttpRequest();
  req.open('GET', '/refresh_plot', false);
  req.onreadystatechange = function(e) {
    if(req.readyState !== 4) {
        return;
    }
    if ([200, 304].indexOf(req.status) === -1) {
        console.warn('Error! XHR failed.');
    } else {
      data = JSON.parse(e.target.responseText);
      plotDataSelector();
    }
  };
  req.send();
}

// refresh plot every 1s
refreshPlot();
// setInterval(function() {
//   refreshPlot();
// }, 10000);  

</script>

</html>